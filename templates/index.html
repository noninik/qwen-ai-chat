<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI –ß–∞—Ç ‚Äî Qwen3</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <!-- –°–∞–π–¥–±–∞—Ä -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>üí¨ –ß–∞—Ç—ã</h3>
            <button class="sidebar-close" onclick="toggleSidebar()">‚úï</button>
        </div>
        <a href="/new" class="new-chat-sidebar-btn">+ –ù–æ–≤—ã–π —á–∞—Ç</a>
        <div class="chat-list">
            {% if chat_list %}
                {% for chat in chat_list %}
                <div class="chat-item-wrapper">
                    <a href="/chat/{{ chat.id }}" class="chat-item {% if current_chat_id == chat.id %}active{% endif %}">
                        <span class="chat-title">
                            {% if chat.has_memory %}üß†{% endif %}
                            {{ chat.title }}
                        </span>
                        <span class="chat-meta">{{ chat.msg_count }} üí¨</span>
                    </a>
                    <div class="chat-actions">
                        <a href="/continue/{{ chat.id }}" class="continue-btn" title="–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ –Ω–æ–≤–æ–º —á–∞—Ç–µ">üîÑ</a>
                        <a href="/delete/{{ chat.id }}" class="delete-btn" title="–£–¥–∞–ª–∏—Ç—å" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?')">üóëÔ∏è</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-chats">–ü–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</p>
            {% endif %}
        </div>
        <div class="token-counter">
            <span>üìä –í—Å–µ–≥–æ —Ç–æ–∫–µ–Ω–æ–≤: ~{{ token_count }}</span>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div class="container">
        <header>
            <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div class="header-center">
                <h1>ü§ñ AI –ß–∞—Ç</h1>
                <p class="subtitle">Powered by Qwen3-Coder</p>
            </div>
            <div class="header-actions">
                <button class="theme-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <a href="/clear/{{ session_id }}" class="clear-btn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóëÔ∏è</a>
                <a href="/export/{{ session_id }}" class="export-btn" title="–°–∫–∞—á–∞—Ç—å —á–∞—Ç">üì•</a>
            </div>
        </header>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div class="settings-bar">
            <div class="setting">
                <label>üß† –ú–æ–¥–µ–ª—å:</label>
                <select id="modelSelect" form="chatForm" name="model_name">
                    {% for name in models %}
                    <option value="{{ name }}" {% if name == selected_model %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="setting">
                <label>üé≠ –†–æ–ª—å:</label>
                <select id="roleSelect" form="chatForm" name="role_name">
                    {% for name in roles %}
                    <option value="{{ name }}" {% if name == selected_role %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç-–±–∞—Ä -->
        <div class="context-bar">
            {% if context_info %}
            <div class="context-info">
                <span>üí¨ {{ context_info.messages }} —Å–æ–æ–±—â–µ–Ω–∏–π</span>
                <span>üìä ~{{ context_info.tokens }} —Ç–æ–∫–µ–Ω–æ–≤</span>
                {% if context_info.compressed %}
                <span class="memory-badge">üß† –ü–∞–º—è—Ç—å ({{ context_info.summaries_count }} —Å–∞–º–º–∞—Ä–∏)</span>
                {% endif %}
            </div>
            <div class="context-progress">
                <div class="context-progress-bar" style="width: {{ context_info.percent }}%"></div>
            </div>
            {% if context_info.percent > 70 %}
            <div class="context-warning">
                ‚ö†Ô∏è –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è. 
                <a href="/continue/{{ session_id }}">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤ –Ω–æ–≤–æ–º —á–∞—Ç–µ —Å –ø–∞–º—è—Ç—å—é ‚Üí</a>
            </div>
            {% endif %}
            {% endif %}

            {% if continued_from %}
            <div class="continued-notice">
                üîÑ –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —á–∞—Ç–∞ "{{ continued_from }}" ‚Äî –Ω–µ–π—Ä–æ–Ω–∫–∞ –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä
            </div>
            {% endif %}
        </div>

        <!-- –ß–∞—Ç -->
        <div class="chat-box" id="chatBox">
            {% if messages %}
                {% for msg in messages %}
                    {% if msg.role == "user" %}
                    <div class="message user-msg">
                        <div class="avatar">üë§</div>
                        <div class="bubble">{{ msg.content }}</div>
                    </div>
                    {% elif msg.role == "assistant" %}
                    <div class="message bot-msg">
                        <div class="avatar">ü§ñ</div>
                        <div class="bubble">
                            <div class="markdown-content">{{ msg.html | safe }}</div>
                            <button class="copy-btn" onclick="copyMessage(this)" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="welcome">
                    {% if continued_from %}
                    <h2>üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º!</h2>
                    <p>–Ø –ø–æ–º–Ω—é –Ω–∞—à –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä. –ú–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å!</p>
                    {% else %}
                    <h2>üëã –ü—Ä–∏–≤–µ—Ç!</h2>
                    <p>–í—ã–±–µ—Ä–∏ –º–æ–¥–µ–ª—å –∏ —Ä–æ–ª—å —Å–≤–µ—Ä—Ö—É, –∑–∞—Ç–µ–º –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å!</p>
                    {% endif %}
                    <div class="suggestions">
                        <button onclick="fillQuestion('–ù–∞–ø–∏—à–∏ –ø–æ–ª–Ω—ã–π –∫–æ–¥ TODO-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ Python')">
                            üíª –ù–∞–ø–∏—à–∏ TODO-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                        </button>
                        <button onclick="fillQuestion('–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —Ç–∞–∫–æ–µ API –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏')">
                            üìñ –ß—Ç–æ —Ç–∞–∫–æ–µ API?
                        </button>
                        <button onclick="fillQuestion('–ù–∞–ø–∏—à–∏ –ø–æ–ª–Ω—ã–π HTML/CSS/JS —Å–∞–π—Ç-–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ')">
                            üåê –°–∞–π—Ç-–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
                        </button>
                        <button onclick="fillQuestion('–ü—Ä–∏–¥—É–º–∞–π –∏–¥–µ—é –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞ –∏ —Ä–∞—Å–ø–∏—à–∏ –±–∏–∑–Ω–µ—Å-–ø–ª–∞–Ω')">
                            üöÄ –ò–¥–µ—è –¥–ª—è —Å—Ç–∞—Ä—Ç–∞–ø–∞
                        </button>
                        <button onclick="fillQuestion('–ù–∞–ø–∏—à–∏ –∏–≥—Ä—É –∑–º–µ–π–∫—É –Ω–∞ JavaScript —Å –ø–æ–ª–Ω—ã–º –∫–æ–¥–æ–º')">
                            üéÆ –ò–≥—Ä–∞ –∑–º–µ–π–∫–∞ –Ω–∞ JS
                        </button>
                        <button onclick="fillQuestion('–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã —É–¥–∞–ª—ë–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã')">
                            üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                        </button>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- –§–æ—Ä–º–∞ -->
        <form action="/chat" method="post" class="input-form" id="chatForm" onsubmit="showLoading()">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <input
                type="text"
                name="user_message"
                id="userInput"
                placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                autocomplete="off"
                required
            >
            <button type="submit" id="sendBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M2 21L23 12L2 3V10L17 12L2 14V21Z" fill="white"/>
                </svg>
            </button>
        </form>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div class="loading" id="loading" style="display: none;">
            <div class="loading-dots">
                <span>ü§ñ –î—É–º–∞—é</span>
                <div class="dots">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="copy-toast" id="copyToast">‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</div>

    <script src="/static/script.js"></script>
</body>
</html>
